{% extends 'base.html' %}
{% load cart_tools %}

{% block page_header %}
	<div class="container header-container">
		<div class="row">
			<div class="col">

		    </div>
		</div>
	</div>
{% endblock %}

{% block content %}
	<div class="overlay"></div>
	<div class="container bg-white rounded mb-2">
		<div class="row">
			<div class="col">
				<h1 class="display-4 logo-font mb-4">Your Cart</h1>
			</div>
		</div>
		<div class="row">
			<div class="col">
			    {% if cart_items %}
					<div class="table-responsive rounded">
						<table class="table table-sm table-borderless">
							<thead class="text-info">
								<tr>
									<th scope="col">Item</th>
									<th scope="col">Description</th>
									<th scope="col">Qty</th>
									<th scope="col">Price</th>
								</tr>
							</thead>
							<tbody>
								{% for item in cart_items %}
									<tr>
										<td class="p-0 w-25">
											<img class="img-fluid" src="{{ item.product.image.url }}">
										</td>
										<td class="w-50">
											<p>{{ item.product.name }}</p>
											<p class="p-0 m-0"><small class="text-muted">${{ item.product.price }} each</small></p>
											<small class="text-muted">{{ item.product.description }}</small>
										</td>
										<td>
											<form class="form" method="POST" action="{% url 'adjust_cart' item.item_id %}">
					                            {% csrf_token %}
					                            <div class="form-group">
													<div class="input-group mb-3">
														<input type="number" class="form-control form-control-sm" value="{{ item.quantity }}" name="quantity" min="0" max="99">
														<div class="input-group-append">
															<button type="submit" class="btn btn-sm btn-outline-info" type="button">Update</button>
														</div>
													</div>
					                            </div>
					                        </form>
					                        <a class="remove-item text-danger" id="remove_{{ item.item_id }}"><small>Remove</small></a>
										</td>
										<td>
											<p>${{ item.product.price | calc_subtotal:item.quantity }}</p>
										</td>
									</tr>
								{% endfor %}
								<tr>
									<td colspan="4" class="pt-5 text-right">
										<h4><strong>Cart Total: ${{ total }}</strong></h4>
									</td>
								</tr>
								<tr>
									<td colspan="4" class="text-right">
										<a href="{% url 'checkout' %}" class="btn btn-success">
											<span class="icon">
												<i class="far fa-credit-card"></i>
											</span>
											<span class="font-weight-bold">Checkout</span>
										</a>
									</td>
								</tr>

							</tbody>
						</table>
					</div>
			    {% else %}
				    <p>Your cart is empty.</p>
			    {% endif %}
		    </div>
		</div>
	</div>
{% endblock %}

{% block postloadjs %}
	{{ block.super }}
	<script type="text/javascript">
		// Remove item and reload on click
		$('.remove-item').click(function(){

			var csrfToken = "{{ csrf_token }}"
			var itemId = $(this).attr('id').split('remove_')[1];
			var url = `/cart/remove/${itemId}/`;
			var data = {'csrfmiddlewaretoken': csrfToken};

			$.post(url, data)
			 .done(function() {
				$('.toast').toast('show');
				location.reload();
			})
		})
	</script>
{% endblock %}